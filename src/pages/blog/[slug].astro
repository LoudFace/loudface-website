---
/**
 * Blog Detail Page - Editorial Magazine Design
 *
 * Creative, high-quality reading experience with:
 * - Reading progress bar
 * - Enhanced hero with category, title, author info
 * - Sticky TOC sidebar (desktop)
 * - Premium prose styling
 * - Author bio card
 * - Related posts section
 */
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/ui/Header.astro';
import Footer from '../../components/ui/Footer.astro';
import SectionContainer from '../../components/ui/SectionContainer.astro';
import { COLLECTION_IDS } from '../../lib/constants';
import { fetchHomepageData, getAccessToken, getEmptyHomepageData } from '../../lib/cms-data';
import type { BlogPost, Category, TeamMember } from '../../lib/types';
import { avatarImage, heroImage, thumbnailImage, ImageSizes, optimizeImage } from '../../lib/image-utils';

// SSR - fetch CMS data at request time
export const prerender = false;

const { slug } = Astro.params;

// Support both Webflow Cloud runtime and local .env
const accessToken = getAccessToken(Astro.locals);

let post: BlogPost | null = null;
let category: Category | null = null;
let author: TeamMember | null = null;
let relatedPosts: BlogPost[] = [];
let error: string | null = null;

// Fetch all CMS data for related posts and lookups
const cmsData = accessToken
  ? await fetchHomepageData(accessToken)
  : getEmptyHomepageData();

const { blogPosts, categories, teamMembers, caseStudies } = cmsData;

if (accessToken) {
  try {
    // Fetch blog posts with content field
    const postsRes = await fetch(
      `https://api.webflow.com/v2/collections/${COLLECTION_IDS['blog']}/items`,
      { headers: { 'Authorization': `Bearer ${accessToken}` } }
    );

    if (postsRes.ok) {
      const postsData = await postsRes.json();
      const item = postsData.items?.find((i: any) => i.fieldData?.slug === slug);

      if (item) {
        post = { id: item.id, ...item.fieldData, createdOn: item.createdOn, lastUpdated: item.lastUpdated };

        // Get category and author from the maps
        if (post.category) {
          category = categories.get(post.category) || null;
        }
        if (post.author) {
          author = teamMembers.get(post.author) || null;
        }

        // Get related posts (same category first, then fill with latest)
        const sameCategoryPosts = blogPosts
          .filter(p => p.slug !== slug && p.category === post!.category)
          .slice(0, 3);

        if (sameCategoryPosts.length < 3) {
          const otherPosts = blogPosts
            .filter(p => p.slug !== slug && !sameCategoryPosts.some(sp => sp.slug === p.slug))
            .slice(0, 3 - sameCategoryPosts.length);
          relatedPosts = [...sameCategoryPosts, ...otherPosts];
        } else {
          relatedPosts = sameCategoryPosts;
        }
      }
    } else {
      error = `API error: ${postsRes.status}`;
    }
  } catch (e) {
    error = 'Failed to fetch blog post';
    console.error('Blog post fetch error:', e);
  }
} else {
  error = 'CMS not configured';
}

// Redirect to 404 if post not found
if (!post && !error) {
  const base = import.meta.env.BASE_URL || '/';
  const baseWithSlash = base.endsWith('/') ? base : `${base}/`;
  return Astro.redirect(`${baseWithSlash}404`);
}

// Page metadata
const title = post?.['meta-title'] || post?.name ? `${post?.['meta-title'] || post?.name} | LoudFace` : 'Blog | LoudFace';
const description = post?.['meta-description'] || post?.excerpt || 'Read our latest blog post';
const canonicalUrl = `https://www.loudface.co/blog/${slug}`;
const publishedDate = post?.['published-date'] || (post as any)?.createdOn;
const modifiedDate = (post as any)?.lastUpdated || publishedDate;

// Extract TOC and add IDs to headings
function extractTocAndAddIds(html: string | undefined): { toc: { id: string; text: string }[]; html: string } {
  if (!html) return { toc: [], html: '' };
  const toc: { id: string; text: string }[] = [];
  let index = 0;

  const processedHtml = html.replace(/<h2([^>]*)>(.*?)<\/h2>/gi, (match, attrs, content) => {
    const text = content.replace(/<[^>]*>/g, '').trim();
    const id = `section-${index++}-${text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')}`;
    toc.push({ id, text });
    return `<h2${attrs} id="${id}">${content}</h2>`;
  });

  return { toc, html: processedHtml };
}

const { toc, html: processedBody } = extractTocAndAddIds(post?.content);

// Structured Data - BreadcrumbList
const breadcrumbSchema = post ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://www.loudface.co/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://www.loudface.co/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.name
    }
  ]
} : null;

// Structured Data - BlogPosting
const articleSchema = post ? {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.name,
  "description": description,
  "image": post.thumbnail?.url || "https://www.loudface.co/images/og-image.jpg",
  "author": author ? {
    "@type": "Person",
    "name": author.name,
    "jobTitle": author['job-title'] || undefined,
    "image": author['profile-picture']?.url || undefined
  } : {
    "@type": "Organization",
    "name": "LoudFace",
    "url": "https://www.loudface.co"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LoudFace",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.loudface.co/images/loudface.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalUrl
  },
  "datePublished": publishedDate ? new Date(publishedDate).toISOString() : new Date().toISOString(),
  "dateModified": modifiedDate ? new Date(modifiedDate).toISOString() : new Date().toISOString(),
  ...(category ? { "articleSection": category.name } : {}),
  ...(post['time-to-read'] ? { "timeRequired": `PT${post['time-to-read'].replace(/[^0-9]/g, '')}M` } : {})
} : null;

// Helper functions
function formatDate(dateStr: string | undefined): string {
  if (!dateStr) return '';
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function formatDateShort(dateStr: string | undefined): string {
  if (!dateStr) return '';
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function getRelatedCategory(categoryId: string | undefined): Category | undefined {
  if (!categoryId) return undefined;
  return categories.get(categoryId);
}

function getRelatedAuthor(authorId: string | undefined): TeamMember | undefined {
  if (!authorId) return undefined;
  return teamMembers.get(authorId);
}

// Base URL for internal links (ensure trailing slash)
const rawBase = import.meta.env.BASE_URL || '/';
const baseUrl = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;

// Share URLs
const shareUrl = encodeURIComponent(canonicalUrl);
const shareTitle = encodeURIComponent(post?.name || '');
const twitterShareUrl = `https://twitter.com/intent/tweet?url=${shareUrl}&text=${shareTitle}`;
const linkedinShareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`;
---

<Layout title={title} description={description} canonicalUrl={canonicalUrl}>
  {/* Structured Data */}
  {breadcrumbSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} slot="head" />
  )}
  {articleSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  )}

  <div class="page-wrapper">
    <Header />

    <!-- Reading Progress Bar -->
    <div
      id="progress-bar"
      class="fixed top-[61px] left-0 h-[3px] bg-primary-500 z-40 transition-[width] duration-75"
      style="width: 0%"
      aria-hidden="true"
    ></div>

    <main id="main-content" class="main-wrapper">
      {error ? (
        <SectionContainer>
          <div class="text-center py-16">
            <h1 class="text-4xl md:text-5xl font-medium text-surface-900">Error</h1>
            <p class="mt-4 text-lg text-surface-600">{error}</p>
          </div>
        </SectionContainer>
      ) : post ? (
        <article>
          <!-- Hero Section -->
          <SectionContainer padding="lg">
            <div class="max-w-4xl mx-auto">
              <!-- Breadcrumb -->
              <nav class="mb-8" aria-label="Breadcrumb">
                <ol class="flex items-center gap-2 text-sm text-surface-500">
                  <li><a href={baseUrl} class="hover:text-surface-900 transition-colors">Home</a></li>
                  <li aria-hidden="true">/</li>
                  <li><a href={`${baseUrl}blog`} class="hover:text-surface-900 transition-colors">Blog</a></li>
                  <li aria-hidden="true">/</li>
                  <li class="text-surface-700 truncate max-w-[200px]">{post.name}</li>
                </ol>
              </nav>

              <!-- Category Pill + Read Time -->
              <div class="flex items-center gap-3 mb-6">
                {category && (
                  <span class="inline-block px-3 py-1 bg-primary-600 text-white text-xs font-medium uppercase tracking-wide rounded-full">
                    {category.name}
                  </span>
                )}
                {post['time-to-read'] && (
                  <span class="text-surface-500 text-sm flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {post['time-to-read']}
                  </span>
                )}
              </div>

              <!-- Title -->
              <h1 class="text-3xl md:text-4xl lg:text-5xl font-medium text-surface-900 leading-[1.15]">
                {post.name}
              </h1>

              <!-- Excerpt/Lead -->
              {post.excerpt && (
                <p class="mt-6 text-xl text-surface-600 leading-relaxed">
                  {post.excerpt}
                </p>
              )}

              <!-- Author Info -->
              <div class="flex items-center gap-4 mt-8 pt-8 border-t border-surface-200">
                {author?.['profile-picture']?.url && (
                  <img
                    src={optimizeImage(author['profile-picture'].url, ImageSizes.avatarLarge)}
                    alt={author.name}
                    class="w-14 h-14 rounded-full object-cover ring-2 ring-surface-100"
                    loading="eager"
                  />
                )}
                <div>
                  {author && (
                    <p class="font-medium text-surface-900">{author.name}</p>
                  )}
                  <div class="flex items-center gap-2 text-sm text-surface-500">
                    {author?.['job-title'] && (
                      <span>{author['job-title']}</span>
                    )}
                    {author?.['job-title'] && post['published-date'] && (
                      <span>·</span>
                    )}
                    {post['published-date'] && (
                      <time datetime={post['published-date']}>{formatDate(post['published-date'])}</time>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </SectionContainer>

          <!-- Hero Image -->
          {post.thumbnail?.url && (() => {
            const hero = heroImage(post.thumbnail.url);
            return (
              <div class="px-4 md:px-8 lg:px-12 mb-12 lg:mb-16">
                <div class="max-w-5xl mx-auto">
                  <div class="rounded-2xl overflow-hidden shadow-lg">
                    <img
                      src={hero.src}
                      srcset={hero.srcset}
                      sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1000px"
                      alt={post.thumbnail.alt || post.name}
                      class="w-full h-auto"
                      loading="eager"
                      fetchpriority="high"
                    />
                  </div>
                </div>
              </div>
            );
          })()}

          <!-- Content + Sidebar -->
          <SectionContainer padding="none">
            <div class="max-w-5xl mx-auto lg:grid lg:grid-cols-[1fr_220px] lg:gap-16">
              <!-- Main Content -->
              <div class="prose-blog" set:html={processedBody} />

              <!-- Sidebar (desktop only) -->
              <aside class="hidden lg:block">
                <div class="sticky top-24 space-y-8">
                  <!-- Table of Contents -->
                  {toc.length > 0 && (
                    <nav class="toc-nav">
                      <p class="text-xs font-medium text-surface-500 uppercase tracking-wide mb-3">
                        Contents
                      </p>
                      <ul class="space-y-1">
                        {toc.map((item) => (
                          <li>
                            <a
                              href={`#${item.id}`}
                              class="toc-link block text-sm text-surface-600 hover:text-primary-600 py-1.5 pl-3 border-l-2 border-surface-200 hover:border-primary-500 transition-colors"
                            >
                              {item.text}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </nav>
                  )}

                  <!-- Share Buttons -->
                  <div>
                    <p class="text-xs font-medium text-surface-500 uppercase tracking-wide mb-3">
                      Share
                    </p>
                    <div class="flex items-center gap-2">
                      <!-- Twitter/X -->
                      <a
                        href={twitterShareUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="share-btn"
                        aria-label="Share on Twitter"
                      >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                        </svg>
                      </a>

                      <!-- LinkedIn -->
                      <a
                        href={linkedinShareUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="share-btn"
                        aria-label="Share on LinkedIn"
                      >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                        </svg>
                      </a>

                      <!-- Copy Link -->
                      <button
                        id="copy-link-btn"
                        class="share-btn"
                        aria-label="Copy link"
                        data-url={canonicalUrl}
                      >
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </aside>
            </div>
          </SectionContainer>

          <!-- Mobile Share Buttons -->
          <div class="lg:hidden px-4 md:px-8 mt-8">
            <div class="max-w-3xl mx-auto flex items-center justify-center gap-3">
              <span class="text-sm text-surface-500">Share:</span>
              <a
                href={twitterShareUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="share-btn"
                aria-label="Share on Twitter"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
              </a>
              <a
                href={linkedinShareUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="share-btn"
                aria-label="Share on LinkedIn"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                </svg>
              </a>
              <button
                class="share-btn mobile-copy-link"
                aria-label="Copy link"
                data-url={canonicalUrl}
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Author Bio Card -->
          {author && (
            <SectionContainer padding="lg">
              <div class="max-w-3xl mx-auto">
                <div class="bg-surface-50 rounded-2xl p-8 md:p-10 flex flex-col sm:flex-row gap-6">
                  {author['profile-picture']?.url && (
                    <img
                      src={optimizeImage(author['profile-picture'].url, 200)}
                      alt={author.name}
                      class="w-20 h-20 sm:w-24 sm:h-24 rounded-full object-cover flex-shrink-0"
                      loading="lazy"
                    />
                  )}
                  <div>
                    <p class="text-sm text-surface-500 mb-1">Written by</p>
                    <p class="text-xl font-medium text-surface-900">{author.name}</p>
                    {author['job-title'] && (
                      <p class="text-surface-600">{author['job-title']}</p>
                    )}
                    {author['bio-summary'] && (
                      <p class="mt-4 text-surface-600 leading-relaxed">{author['bio-summary']}</p>
                    )}
                  </div>
                </div>
              </div>
            </SectionContainer>
          )}

          <!-- Related Posts -->
          {relatedPosts.length > 0 && (
            <SectionContainer>
              <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl sm:text-3xl font-medium text-surface-900 mb-8">
                  Related Articles
                </h2>
                <div class="grid md:grid-cols-3 gap-6">
                  {relatedPosts.map((relatedPost, index) => {
                    const relatedCategory = getRelatedCategory(relatedPost.category);
                    const relatedAuthor = getRelatedAuthor(relatedPost.author);
                    return (
                      <a
                        href={`${baseUrl}blog/${relatedPost.slug}`}
                        class="related-card group rounded-xl overflow-hidden border border-surface-200 bg-white hover:border-surface-300 hover:shadow-md transition-all duration-200 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-4"
                      >
                        {/* Thumbnail */}
                        <div class="aspect-[16/10] overflow-hidden bg-surface-100">
                          {relatedPost.thumbnail?.url ? (
                            <img
                              src={thumbnailImage(relatedPost.thumbnail.url)}
                              alt={relatedPost.thumbnail.alt || relatedPost.name}
                              class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                              loading="lazy"
                            />
                          ) : (
                            <div class="w-full h-full flex items-center justify-center">
                              <span class="text-surface-400">No image</span>
                            </div>
                          )}
                        </div>

                        {/* Content */}
                        <div class="p-5">
                          {/* Category + Read Time */}
                          <div class="flex items-center gap-2 text-xs text-surface-500 mb-2">
                            {relatedCategory && (
                              <span class="font-medium text-primary-600 uppercase tracking-wide">
                                {relatedCategory.name}
                              </span>
                            )}
                            {relatedCategory && relatedPost['time-to-read'] && (
                              <span>·</span>
                            )}
                            {relatedPost['time-to-read'] && (
                              <span>{relatedPost['time-to-read']}</span>
                            )}
                          </div>

                          {/* Title */}
                          <h3 class="text-base font-medium text-surface-900 group-hover:text-primary-600 transition-colors line-clamp-2">
                            {relatedPost.name}
                          </h3>

                          {/* Date */}
                          {relatedPost['published-date'] && (
                            <p class="mt-3 text-xs text-surface-500">
                              {formatDateShort(relatedPost['published-date'])}
                            </p>
                          )}
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
            </SectionContainer>
          )}

          <!-- Back to Blog CTA -->
          <SectionContainer padding="sm">
            <div class="max-w-3xl mx-auto text-center">
              <a
                href={`${baseUrl}blog`}
                class="inline-flex items-center gap-2 px-6 py-3 border border-surface-200 text-surface-900 font-medium rounded-lg hover:bg-surface-50 transition-colors focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2"
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Back to Blog
              </a>
            </div>
          </SectionContainer>
        </article>
      ) : null}
    </main>

    <Footer caseStudies={caseStudies} blogPosts={blogPosts} />
  </div>
</Layout>

<style>
  /* Premium Prose Styling */
  .prose-blog {
    max-width: 65ch;
    color: rgb(var(--color-surface-700));
    line-height: 1.75;
    font-size: 1.125rem;
  }

  .prose-blog :global(h2) {
    font-size: 1.5rem;
    font-weight: 500;
    color: rgb(var(--color-surface-900));
    margin-top: 3rem;
    margin-bottom: 1rem;
    scroll-margin-top: 6rem;
  }

  .prose-blog :global(h3) {
    font-size: 1.25rem;
    font-weight: 500;
    color: rgb(var(--color-surface-900));
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose-blog :global(h4) {
    font-size: 1.125rem;
    font-weight: 500;
    color: rgb(var(--color-surface-900));
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .prose-blog :global(p) {
    margin-bottom: 1.5rem;
  }

  .prose-blog :global(a) {
    color: rgb(var(--color-primary-600));
    text-decoration: underline;
    text-decoration-color: rgb(var(--color-primary-300));
    text-underline-offset: 2px;
    transition: text-decoration-color 0.2s;
  }

  .prose-blog :global(a:hover) {
    text-decoration-color: rgb(var(--color-primary-500));
  }

  .prose-blog :global(strong) {
    color: rgb(var(--color-surface-900));
    font-weight: 600;
  }

  .prose-blog :global(blockquote) {
    background: rgb(var(--color-surface-50));
    border-left: 4px solid rgb(var(--color-primary-500));
    padding: 1rem 1.5rem;
    margin: 2rem 0;
    border-radius: 0 0.5rem 0.5rem 0;
    font-style: italic;
    color: rgb(var(--color-surface-700));
  }

  .prose-blog :global(blockquote p) {
    margin-bottom: 0;
  }

  .prose-blog :global(img) {
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    margin: 2rem 0;
    max-width: 100%;
    height: auto;
  }

  .prose-blog :global(ul),
  .prose-blog :global(ol) {
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .prose-blog :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose-blog :global(ul li) {
    list-style-type: disc;
  }

  .prose-blog :global(ol li) {
    list-style-type: decimal;
  }

  .prose-blog :global(code) {
    background: rgb(var(--color-surface-100));
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: var(--font-mono);
  }

  .prose-blog :global(pre) {
    background: rgb(var(--color-surface-900));
    color: rgb(var(--color-surface-100));
    padding: 1.5rem;
    border-radius: 0.75rem;
    overflow-x: auto;
    margin: 2rem 0;
    font-size: 0.875rem;
  }

  .prose-blog :global(pre code) {
    background: transparent;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
  }

  .prose-blog :global(hr) {
    border: 0;
    border-top: 1px solid rgb(var(--color-surface-200));
    margin: 3rem 0;
  }

  .prose-blog :global(figure) {
    margin: 2rem 0;
  }

  .prose-blog :global(figcaption) {
    text-align: center;
    font-size: 0.875rem;
    color: rgb(var(--color-surface-500));
    margin-top: 0.75rem;
  }

  /* Share Button Styles */
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 9999px;
    background: rgb(var(--color-surface-100));
    color: rgb(var(--color-surface-600));
    transition: all 0.2s;
  }

  .share-btn:hover {
    background: rgb(var(--color-surface-200));
    color: rgb(var(--color-surface-900));
  }

  /* TOC Active State (enhanced with JS) */
  .toc-link.active {
    color: rgb(var(--color-primary-600));
    border-left-color: rgb(var(--color-primary-500));
  }

  /* Related Posts Card */
  .related-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: rgb(var(--color-primary-500));
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 0.75rem 0 0 0.75rem;
  }

  .related-card {
    position: relative;
  }

  .related-card:hover::before {
    opacity: 1;
  }

  /* Line clamp */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Reading Progress Bar
  function updateProgressBar() {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
    const progressBar = document.getElementById('progress-bar');
    if (progressBar) {
      progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
  }

  window.addEventListener('scroll', updateProgressBar, { passive: true });
  updateProgressBar();

  // TOC Active State
  function updateTocActive() {
    const headings = document.querySelectorAll('.prose-blog h2[id]');
    const tocLinks = document.querySelectorAll('.toc-link');

    if (headings.length === 0 || tocLinks.length === 0) return;

    let activeId = '';
    const scrollTop = window.scrollY + 120;

    headings.forEach((heading) => {
      if ((heading as HTMLElement).offsetTop <= scrollTop) {
        activeId = heading.id;
      }
    });

    tocLinks.forEach((link) => {
      const href = link.getAttribute('href');
      if (href === `#${activeId}`) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  }

  window.addEventListener('scroll', updateTocActive, { passive: true });
  updateTocActive();

  // Copy Link Button
  function setupCopyButtons() {
    const copyButtons = document.querySelectorAll('#copy-link-btn, .mobile-copy-link');
    copyButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url');
        if (url) {
          try {
            await navigator.clipboard.writeText(url);
            // Show feedback
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
            setTimeout(() => {
              btn.innerHTML = originalHtml;
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
    });
  }

  setupCopyButtons();

  // Smooth scroll for TOC links
  document.querySelectorAll('.toc-link').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = link.getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    });
  });
</script>
