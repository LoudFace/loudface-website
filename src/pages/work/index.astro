---
/**
 * Work / Case Studies Gallery Page
 *
 * Displays all case studies in a bento-style grid with:
 * - Hero section with stats
 * - CMS-powered gallery with client brand colors
 * - SEO structured data
 */
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/ui/Header.astro';
import Footer from '../../components/ui/Footer.astro';
import SectionContainer from '../../components/ui/SectionContainer.astro';
import SectionHeader from '../../components/ui/SectionHeader.astro';
import { createCMS } from '../../lib/cms';
import { fetchHomepageData, getAccessToken, getEmptyHomepageData } from '../../lib/cms-data';
import { getWorkContent } from '../../lib/content-utils';
import { asset } from '../../lib/assets';
import type { CaseStudy, Client, Industry, Technology } from '../../lib/types';

// SSR - fetch CMS data at request time
export const prerender = false;

// Load static content
const content = getWorkContent();

// Fetch CMS data
const accessToken = getAccessToken(Astro.locals);
const cmsData = accessToken
  ? await fetchHomepageData(accessToken)
  : getEmptyHomepageData();

const {
  caseStudies: rawCaseStudies,
  clients: clientsMap,
  industries: industriesMap,
  technologies: technologiesMap,
  blogPosts
} = cmsData;

// Convert maps to arrays and add IDs
const caseStudies = rawCaseStudies as (CaseStudy & { id: string })[];

// Create CMS helper for control panel
const cms = createCMS('WorkPage');
const gallerySection = cms.section(caseStudies, 'case-studies', 'Case Study Gallery');

// Reference lookups for CMS attributes
const referenceLookups = {
  clients: clientsMap,
  industries: industriesMap,
  technologies: technologiesMap,
};

// Helpers
function getClient(id: string | undefined): Client | undefined {
  if (!id) return undefined;
  return clientsMap.get(id);
}

function getIndustry(id: string | undefined): Industry | undefined {
  if (!id) return undefined;
  return industriesMap.get(id);
}

function getTechnologies(techIds: string[] | undefined): Technology[] {
  if (!techIds || !Array.isArray(techIds)) return [];
  return techIds
    .map(id => technologiesMap.get(id))
    .filter((tech): tech is Technology => tech !== undefined);
}

// Color contrast utilities
function parseColorToRgb(color: string): { r: number; g: number; b: number } | null {
  if (!color || typeof color !== 'string') return null;
  const trimmed = color.trim();

  // Hex format
  if (trimmed.startsWith('#') || /^[0-9a-fA-F]{3,8}$/.test(trimmed)) {
    const hex = trimmed.replace('#', '');
    if (hex.length === 3) {
      return {
        r: parseInt(hex[0] + hex[0], 16),
        g: parseInt(hex[1] + hex[1], 16),
        b: parseInt(hex[2] + hex[2], 16)
      };
    } else if (hex.length >= 6) {
      return {
        r: parseInt(hex.slice(0, 2), 16),
        g: parseInt(hex.slice(2, 4), 16),
        b: parseInt(hex.slice(4, 6), 16)
      };
    }
  }

  // RGB format
  const rgbMatch = trimmed.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
  if (rgbMatch) {
    return {
      r: parseInt(rgbMatch[1], 10),
      g: parseInt(rgbMatch[2], 10),
      b: parseInt(rgbMatch[3], 10)
    };
  }

  return null;
}

function getLuminance(r: number, g: number, b: number): number {
  const toLinear = (c: number) => {
    const sRGB = c / 255;
    return sRGB <= 0.03928 ? sRGB / 12.92 : Math.pow((sRGB + 0.055) / 1.055, 2.4);
  };
  return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
}

function getContrastColors(hexColor: string | undefined): {
  textColor: string;
  mode: 'light' | 'dark';
} {
  if (!hexColor) {
    return { textColor: '#ffffff', mode: 'dark' };
  }

  const rgb = parseColorToRgb(hexColor);
  if (!rgb) {
    return { textColor: '#ffffff', mode: 'dark' };
  }

  const luminance = getLuminance(rgb.r, rgb.g, rgb.b);
  const isLightBg = luminance > 0.4;

  return {
    textColor: isLightBg ? '#0a0a0a' : '#ffffff',
    mode: isLightBg ? 'light' : 'dark',
  };
}

// Separate featured vs regular studies
const featuredStudies = gallerySection.items.filter(s => s.featured);
const regularStudies = gallerySection.items.filter(s => !s.featured);

// Interleave featured and regular for bento effect
const sortedStudies = [...featuredStudies, ...regularStudies];

// Page metadata
const title = "Our Work | LoudFace - Case Studies & Portfolio";
const description = "Explore LoudFace's portfolio of successful Webflow projects. See real results including traffic growth, conversion improvements, and business transformations.";
const canonicalUrl = "https://www.loudface.co/work";

// Structured Data - CollectionPage
const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Case Studies",
  "description": description,
  "url": canonicalUrl,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": sortedStudies.map((study, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `https://www.loudface.co/work/${study.slug}`,
      "name": study['project-title'] || study.name
    }))
  }
};
---

<Layout title={title} description={description} canonicalUrl={canonicalUrl}>
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} slot="head" />

  <div class="page-wrapper">
    <!-- Header Navigation -->
    <Header />

    <main id="main-content" class="main-wrapper">
      <!-- Hero Section -->
      <section class="pt-4">
        <div class="px-4 md:px-8 lg:px-12">
          <div class="max-w-7xl mx-auto">
            <div class="relative border border-surface-200 bg-surface-50 rounded-2xl overflow-hidden">
              <div class="p-8 md:p-12 lg:p-16 text-center">
                <!-- Headline -->
                <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-hero font-medium text-surface-900">
                  {content.headline.split(content.highlightWord)[0]}<span class="text-primary-600">{content.highlightWord}</span>{content.headline.split(content.highlightWord)[1] || ''}
                </h1>

                <!-- Description -->
                <p class="mt-4 text-lg text-surface-600 max-w-2xl mx-auto">
                  {content.description}
                </p>

                <!-- Stats Banner -->
                <div class="mt-10 pt-8 border-t border-surface-200">
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
                    {content.stats.map((stat) => (
                      <div class="text-center">
                        <span class="text-2xl md:text-3xl lg:text-4xl font-medium text-surface-900">{stat.number}</span>
                        <p class="mt-1 text-sm text-surface-600">{stat.label}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Gallery Section -->
      <SectionContainer padding="lg">
        <SectionHeader
          title={content.galleryTitle}
          highlightWord={content.galleryHighlightWord}
          subtitle={content.gallerySubtitle}
        />

        {sortedStudies.length === 0 ? (
          <div class="mt-12 text-center py-16">
            <p class="text-surface-600">No case studies found. Check back soon!</p>
          </div>
        ) : (
          <div
            class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
            {...gallerySection.attrs}
          >
            {sortedStudies.map((study, index) => {
              const client = getClient(study.client);
              const industry = getIndustry(study.industry);
              const technologies = getTechnologies(study.technologies as string[] | undefined);
              const clientColor = study['client-color'] || '#6366f1';
              const secondaryColor = study['secondary-client-color'] || clientColor;
              const hasStats = study['result-1---number'] || study['result-2---number'];

              return (
                <a
                  href={`/work/${study.slug}`}
                  class="group relative bg-white rounded-2xl border border-surface-200 overflow-hidden transition-all duration-300 hover:shadow-xl hover:border-surface-300 hover:-translate-y-1 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-4"
                  {...cms.item(study, 'case-studies', referenceLookups)}
                >
                  {/* Client Color Accent Stripe */}
                  <div
                    class="h-1"
                    style={`background: linear-gradient(90deg, ${clientColor}, ${secondaryColor});`}
                  />

                  {/* Image Section */}
                  <div class="relative aspect-[16/10] overflow-hidden">
                    <img
                      src={study['main-project-image-thumbnail']?.url || asset('/images/placeholder.webp')}
                      alt={study['main-project-image-thumbnail']?.alt || study['project-title'] || study.name}
                      loading={index < 6 ? 'eager' : 'lazy'}
                      class="w-full h-full object-cover object-top transition-transform duration-500 group-hover:scale-105"
                    />

                    {/* Industry Badge - Glass morphism */}
                    {industry && (
                      <span class="absolute top-3 left-3 px-2.5 py-1 bg-white/90 backdrop-blur-sm rounded-full text-xs font-medium text-surface-700 shadow-sm">
                        {industry.name}
                      </span>
                    )}
                  </div>

                  {/* Content Section */}
                  <div class="p-5">
                    {/* Technology Pills */}
                    {technologies.length > 0 && (
                      <div class="flex flex-wrap gap-1.5 mb-3">
                        {technologies.slice(0, 3).map((tech) => (
                          <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-surface-100 rounded text-2xs font-medium text-surface-600">
                            {tech.name}
                          </span>
                        ))}
                        {technologies.length > 3 && (
                          <span class="px-2 py-0.5 bg-surface-100 rounded text-2xs font-medium text-surface-500">
                            +{technologies.length - 3}
                          </span>
                        )}
                      </div>
                    )}

                    {/* Project Title */}
                    <h2 class="font-medium text-lg text-surface-900 line-clamp-2 group-hover:text-primary-600 transition-colors">
                      {study['project-title'] || study.name}
                    </h2>

                    {/* Summary */}
                    {study['paragraph-summary'] && (
                      <p class="mt-2 text-sm text-surface-600 line-clamp-2">
                        {study['paragraph-summary']}
                      </p>
                    )}

                    {/* Stats Row - Tinted with client color */}
                    {hasStats && (() => {
                      const hasBothStats = study['result-1---number'] && study['result-2---number'];
                      return (
                        <div class={`mt-4 ${hasBothStats ? 'grid grid-cols-2 gap-2' : ''}`}>
                          {study['result-1---number'] && (
                            <div
                              class="rounded-lg p-3"
                              style={`background-color: ${clientColor}10;`}
                            >
                              <span class="block text-xl font-medium text-surface-900">
                                {study['result-1---number']}
                              </span>
                              <span class="text-xs text-surface-600 line-clamp-1">
                                {study['result-1---title']}
                              </span>
                            </div>
                          )}
                          {study['result-2---number'] && (
                            <div
                              class="rounded-lg p-3"
                              style={`background-color: ${clientColor}10;`}
                            >
                              <span class="block text-xl font-medium text-surface-900">
                                {study['result-2---number']}
                              </span>
                              <span class="text-xs text-surface-600 line-clamp-1">
                                {study['result-2---title']}
                              </span>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                    {/* Footer */}
                    <div class="mt-4 pt-4 border-t border-surface-100 flex items-center justify-between">
                      {/* Client Logo */}
                      <div class="flex-shrink-0">
                        {client?.['colored-logo']?.url ? (
                          <img
                            src={client['colored-logo'].url}
                            alt={client.name || 'Client'}
                            class="h-5 w-auto max-w-[100px] object-contain opacity-60 group-hover:opacity-100 transition-opacity"
                            loading="lazy"
                          />
                        ) : (
                          <span class="text-sm font-medium text-surface-400">
                            {client?.name || ''}
                          </span>
                        )}
                      </div>

                      {/* CTA */}
                      <span class="flex items-center gap-1.5 text-sm font-medium text-surface-500 group-hover:text-primary-600 transition-colors">
                        {content.viewProjectText}
                        <svg
                          class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                          viewBox="0 0 16 16"
                          fill="none"
                        >
                          <path
                            d="M3 8h10M9 4l4 4-4 4"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </span>
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        )}
      </SectionContainer>
    </main>

    <!-- Footer -->
    <Footer caseStudies={caseStudies} blogPosts={blogPosts} />

    <!-- Webflow Enterprise Partner Badge -->
    <a
      href="https://webflow.com/@loudface"
      target="_blank"
      rel="noopener noreferrer"
      class="fixed bottom-6 right-6 z-50 transition-opacity hover:opacity-80"
      aria-label="Webflow Enterprise Partner"
    >
      <img
        loading="lazy"
        src={asset('/images/Enterprise-Blue-Badge.webp')}
        alt="Webflow Enterprise Partner Badge"
        class="w-24 h-auto drop-shadow-lg"
      />
    </a>
  </div>
</Layout>
