---
import { applyCMSConfig } from '../../lib/cms-utils';
import { generateCMSAttributes } from '../../lib/cms-attributes';
import { CMS_SECTIONS } from '../../lib/constants';
import { getCaseStudySliderContent } from '../../lib/content-utils';
import type { CaseStudy, Client, Industry, Testimonial } from '../../lib/types';

// Load content from JSON file (editable via /dev/editor)
const content = getCaseStudySliderContent();

interface Props {
  title?: string;
  caseStudies: CaseStudy[];
  clients?: Map<string, Client>;
  industries?: Map<string, Industry>;
  testimonials?: Map<string, Testimonial>;
  ctaText?: string;
}

// Props can still override JSON defaults
const {
  title = content.title,
  caseStudies: rawCaseStudies,
  clients = new Map(),
  industries = new Map(),
  testimonials = new Map(),
  ctaText = content.ctaText
} = Astro.props;

// Apply CMS configuration (filters, sorting) - field mapping auto-generated from schema
const caseStudies = applyCMSConfig(rawCaseStudies, CMS_SECTIONS.CASE_STUDY_SLIDER, 'case-studies');

// Build reference lookups for generateCMSAttributes
const referenceLookups = {
  clients: clients,
  industries: industries,
};

// Helper to get client by ID
function getClient(clientId: string | undefined): Client | undefined {
  if (!clientId) return undefined;
  return clients.get(clientId);
}

// Helper to get testimonial for a case study
function getTestimonial(caseStudyId: string): Testimonial | undefined {
  for (const testimonial of testimonials.values()) {
    if (testimonial['case-study'] === caseStudyId) {
      return testimonial;
    }
  }
  return undefined;
}

/**
 * Parse any color format to RGB values.
 * Supports: hex (#RGB, #RRGGBB, #RRGGBBAA), rgb(), rgba()
 */
function parseColorToRgb(color: string): { r: number; g: number; b: number } | null {
  if (!color || typeof color !== 'string') return null;

  const trimmed = color.trim();

  // Try hex format
  if (trimmed.startsWith('#') || /^[0-9a-fA-F]{3,8}$/.test(trimmed)) {
    const hex = trimmed.replace('#', '');

    if (hex.length === 3) {
      return {
        r: parseInt(hex[0] + hex[0], 16),
        g: parseInt(hex[1] + hex[1], 16),
        b: parseInt(hex[2] + hex[2], 16)
      };
    } else if (hex.length >= 6) {
      return {
        r: parseInt(hex.slice(0, 2), 16),
        g: parseInt(hex.slice(2, 4), 16),
        b: parseInt(hex.slice(4, 6), 16)
      };
    }
  }

  // Try rgb/rgba format
  const rgbMatch = trimmed.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
  if (rgbMatch) {
    return {
      r: parseInt(rgbMatch[1], 10),
      g: parseInt(rgbMatch[2], 10),
      b: parseInt(rgbMatch[3], 10)
    };
  }

  // Try hsl format
  const hslMatch = trimmed.match(/hsla?\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%/i);
  if (hslMatch) {
    const h = parseInt(hslMatch[1], 10) / 360;
    const s = parseInt(hslMatch[2], 10) / 100;
    const l = parseInt(hslMatch[3], 10) / 100;

    const hue2rgb = (p: number, q: number, t: number) => {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    };

    let r, g, b;
    if (s === 0) {
      r = g = b = l;
    } else {
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      r = hue2rgb(p, q, h + 1/3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1/3);
    }

    return {
      r: Math.round(r * 255),
      g: Math.round(g * 255),
      b: Math.round(b * 255)
    };
  }

  return null;
}

function rgbToHsl(r: number, g: number, b: number): { h: number; s: number; l: number } {
  r /= 255;
  g /= 255;
  b /= 255;

  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  let h = 0;
  let s = 0;
  const l = (max + min) / 2;

  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

    switch (max) {
      case r:
        h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
        break;
      case g:
        h = ((b - r) / d + 2) / 6;
        break;
      case b:
        h = ((r - g) / d + 4) / 6;
        break;
    }
  }

  return { h: h * 360, s: s * 100, l: l * 100 };
}

function getLuminance(r: number, g: number, b: number): number {
  const toLinear = (c: number) => {
    const sRGB = c / 255;
    return sRGB <= 0.03928 ? sRGB / 12.92 : Math.pow((sRGB + 0.055) / 1.055, 2.4);
  };
  return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
}

function hslToRgb(h: number, s: number, l: number): { r: number; g: number; b: number } {
  h /= 360;
  s /= 100;
  l /= 100;

  const hue2rgb = (p: number, q: number, t: number) => {
    if (t < 0) t += 1;
    if (t > 1) t -= 1;
    if (t < 1/6) return p + (q - p) * 6 * t;
    if (t < 1/2) return q;
    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
    return p;
  };

  let r, g, b;
  if (s === 0) {
    r = g = b = l;
  } else {
    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    const p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }

  return {
    r: Math.round(r * 255),
    g: Math.round(g * 255),
    b: Math.round(b * 255)
  };
}

function getContrastRatio(bgLuminance: number, fgLuminance: number): number {
  const lighter = Math.max(bgLuminance, fgLuminance);
  const darker = Math.min(bgLuminance, fgLuminance);
  return (lighter + 0.05) / (darker + 0.05);
}

function getContrastColors(hexColor: string | undefined): {
  textColor: string;
  mode: 'light' | 'dark';
  overlayColor: string;
} {
  if (!hexColor) {
    return {
      textColor: 'hsl(0, 0%, 95%)',
      mode: 'dark',
      overlayColor: 'rgba(255, 255, 255, 0.1)'
    };
  }

  const rgb = parseColorToRgb(hexColor);
  if (!rgb) {
    return {
      textColor: 'hsl(0, 0%, 95%)',
      mode: 'dark',
      overlayColor: 'rgba(255, 255, 255, 0.1)'
    };
  }

  const { r, g, b } = rgb;
  const hsl = rgbToHsl(r, g, b);
  const bgLuminance = getLuminance(r, g, b);
  const isLightBg = bgLuminance > 0.4;
  const MIN_CONTRAST = 4.5;

  let saturation = Math.min(hsl.s * 0.7, 60);
  let lightness = isLightBg ? 15 : 90;

  let textRgb = hslToRgb(hsl.h, saturation, lightness);
  let textLuminance = getLuminance(textRgb.r, textRgb.g, textRgb.b);
  let contrast = getContrastRatio(bgLuminance, textLuminance);

  let iterations = 0;
  const maxIterations = 10;

  while (contrast < MIN_CONTRAST && iterations < maxIterations) {
    iterations++;
    saturation = Math.max(saturation - 10, 0);

    if (isLightBg) {
      lightness = Math.max(lightness - 3, 5);
    } else {
      lightness = Math.min(lightness + 2, 98);
    }

    textRgb = hslToRgb(hsl.h, saturation, lightness);
    textLuminance = getLuminance(textRgb.r, textRgb.g, textRgb.b);
    contrast = getContrastRatio(bgLuminance, textLuminance);
  }

  if (contrast < MIN_CONTRAST) {
    return {
      textColor: isLightBg ? 'hsl(0, 0%, 5%)' : 'hsl(0, 0%, 98%)',
      mode: isLightBg ? 'light' : 'dark',
      overlayColor: isLightBg ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.15)'
    };
  }

  const textColor = `hsl(${Math.round(hsl.h)}, ${Math.round(saturation)}%, ${Math.round(lightness)}%)`;
  const overlayColor = isLightBg
    ? `hsla(${Math.round(hsl.h)}, ${Math.round(saturation)}%, 10%, 0.15)`
    : `hsla(${Math.round(hsl.h)}, ${Math.round(saturation)}%, 95%, 0.15)`;

  return {
    textColor,
    mode: isLightBg ? 'light' : 'dark',
    overlayColor
  };
}
---

<section class="pb-16 md:pb-20 overflow-hidden">
  <div class="pt-16 md:pt-20 lg:pt-24">
    <div class="px-4 md:px-8 lg:px-12">
      <div class="max-w-7xl mx-auto">
        <div class="grid gap-6 xs:gap-10 max-w-full">

          <!-- Header with nav -->
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-surface-400 rounded-full" aria-hidden="true"></span>
              <h2 class="text-lg font-medium text-surface-900">{title}</h2>
            </div>
            <div class="hidden md:block">
              <div class="flex gap-2">
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__prev"
                  aria-label="Previous slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__next"
                  aria-label="Next slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Embla Carousel -->
          <div
            id="case-study-slider"
            class="embla w-full max-w-full overflow-hidden"
            data-cms-section={CMS_SECTIONS.CASE_STUDY_SLIDER}
            data-cms-label="Case Study Slider"
          >
            {caseStudies.length > 0 ? (
              <div class="embla__viewport overflow-hidden">
                <div class="embla__container flex items-start gap-10 md:gap-10 touch-pan-y" data-cms-container>
                  {caseStudies.map((study) => {
                    const client = getClient(study.client);
                    const testimonial = getTestimonial(study.id);
                    const { textColor, mode, overlayColor } = getContrastColors(study['client-color']);
                    const cardStyle = study['client-color']
                      ? `background-color: ${study['client-color']}; color: ${textColor}; --card-text: ${textColor}; --card-overlay: ${overlayColor};`
                      : undefined;
                    return (
                      <div
                        class="embla__slide flex-[0_0_100%] md:flex-[0_0_auto] min-w-0 max-w-full md:max-w-[46.25rem]"
                        {...generateCMSAttributes(study, 'case-studies', referenceLookups)}
                      >
                        <div
                          class={`case-card flex flex-col md:flex-row gap-6 rounded-lg p-6 relative transition-opacity duration-250 hover:opacity-85`}
                          style={cardStyle}
                        >
                          <a
                            href={`/work/${study.slug}`}
                            class="absolute inset-0 z-10 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:rounded-lg"
                            style={`--tw-outline-color: var(--card-text, white)`}
                            aria-label={`View ${study['project-title']} case study`}
                          ></a>

                          <!-- Thumbnail -->
                          <div class="flex-none w-full md:w-[280px] max-h-[300px] md:max-h-[400px] rounded-md overflow-hidden">
                            <img
                              src={study['main-project-image-thumbnail']?.url || '/images/placeholder.webp'}
                              alt={study['main-project-image-thumbnail']?.alt || study['project-title']}
                              width="600"
                              height="841"
                              loading="lazy"
                              class="w-full h-full object-cover"
                            />
                          </div>

                          <!-- Content -->
                          <div class="flex-1 flex flex-col">
                            <div class="flex flex-col justify-between h-full gap-4">
                              <!-- Title & Summary -->
                              <div>
                                <h3 class="text-xl font-medium">{study['project-title']}</h3>
                                <div class="h-2"></div>
                                <p class="text-sm opacity-90">{study['paragraph-summary']}</p>
                              </div>

                              <!-- Stats & Testimonial -->
                              <div>
                                {study['result-1---number'] && (
                                  <div class="flex items-center gap-2.5 mb-2">
                                    <div class="rounded-lg px-4 py-2" style="background-color: var(--card-overlay, rgba(255, 255, 255, 0.1))">
                                      <span class="text-lg font-medium">{study['result-1---number']}</span>
                                    </div>
                                    <div class="max-w-[150px]">
                                      <span class="text-sm font-medium">{study['result-1---title']}</span>
                                    </div>
                                  </div>
                                )}

                                {testimonial && (
                                  <>
                                    <div class="h-4"></div>
                                    <div class="rounded-lg p-4 bg-black/50">
                                      <div class="text-sm line-clamp-2" set:html={testimonial['testimonial-body']} />
                                      <div class="h-3"></div>
                                      <div class="text-sm font-bold">{testimonial.name}</div>
                                      <div class="text-xs opacity-75">{testimonial.role}</div>
                                    </div>
                                  </>
                                )}

                                <div class="h-4"></div>
                                <div class="h-px" style="background-color: var(--card-overlay, rgba(255, 255, 255, 0.2))"></div>
                                <div class="h-4"></div>

                                <!-- Footer -->
                                <div class="flex justify-between items-center">
                                  <div class="[&>img]:max-h-5 [&>img]:w-auto">
                                    {client?.['colored-logo']?.url ? (
                                      <img
                                        src={client['colored-logo'].url}
                                        alt={client.name || 'Client logo'}
                                        width="94"
                                        height="20"
                                        loading="lazy"
                                      />
                                    ) : (
                                      <span class="font-medium">{client?.name || ''}</span>
                                    )}
                                  </div>
                                  <div class="flex items-center gap-2 text-sm">
                                    <span class="font-medium">Read case study</span>
                                    <svg width="14" height="14" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                      <path d="M2.91854 1.85641H8.14011L1.06819 8.92834C1.01486 8.98166 0.972567 9.04496 0.94371 9.11463C0.914853 9.1843 0.9 9.25897 0.9 9.33437C0.9 9.40978 0.914853 9.48445 0.94371 9.55412C0.972567 9.62379 1.01486 9.68709 1.06818 9.74041C1.12151 9.79373 1.18481 9.83603 1.25448 9.86488C1.32414 9.89374 1.39881 9.90859 1.47422 9.90859C1.54963 9.90859 1.6243 9.89374 1.69396 9.86488C1.76363 9.83603 1.82693 9.79373 1.88025 9.74041L8.95193 2.66873V7.91349C8.95193 8.06562 9.01236 8.21153 9.11994 8.3191C9.22752 8.42668 9.37342 8.48711 9.52555 8.48711C9.67769 8.48711 9.82359 8.42668 9.93116 8.3191C10.0387 8.21153 10.0992 8.06562 10.0992 7.91349V1.31361C10.0997 1.30337 10.1 1.29311 10.1 1.28281C10.1 1.13052 10.0395 0.984466 9.93182 0.876779C9.82413 0.769092 9.67807 0.708594 9.52578 0.708594C9.51717 0.708594 9.50858 0.708787 9.50001 0.709172H2.91854C2.7664 0.709172 2.6205 0.769607 2.51292 0.877182C2.40535 0.984757 2.34491 1.13066 2.34491 1.28279C2.34491 1.43493 2.40535 1.58083 2.51292 1.6884C2.6205 1.79598 2.7664 1.85641 2.91854 1.85641Z" fill="currentColor" stroke-width="0.2"></path>
                                    </svg>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ) : (
              <div class="text-center py-12 text-surface-500">
                <p>No case studies found.</p>
              </div>
            )}
          </div>

          <!-- Mobile nav buttons -->
          <div class="block md:hidden">
            <div class="flex justify-center items-center">
              <div class="flex gap-2">
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__prev"
                  aria-label="Previous slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__next"
                  aria-label="Next slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="h-8 md:h-12"></div>

        <!-- CTA Button -->
        <div class="text-center">
          <button class="inline-flex items-center justify-center px-6 py-3 bg-surface-900 text-white font-medium rounded-lg transition-colors hover:bg-surface-800">
            {ctaText}
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Embla container - required for carousel functionality */
  .embla__container {
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .embla__container {
      gap: 2.5rem;
    }
  }

  /* Case card - uses dynamic CSS variables for colors */
  .case-card {
    background-color: #dd5232; /* Fallback color */
    color: var(--card-text, inherit);
    max-width: 46.25rem;
  }
</style>
