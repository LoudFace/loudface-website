---
import { applyCMSConfig } from '../../lib/cms-utils';
import { generateCMSAttributes } from '../../lib/cms-attributes';
import { CMS_SECTIONS } from '../../lib/constants';
import { getKnowledgeContent } from '../../lib/content-utils';
import type { BlogPost, Category, TeamMember } from '../../lib/types';

// Load content from JSON file (editable via /dev/editor)
const content = getKnowledgeContent();

// Author type alias for clarity
type Author = Pick<TeamMember, 'id' | 'name'>;

interface Props {
  title?: string;
  highlightWord?: string;
  description?: string;
  posts: BlogPost[];
  categories?: Category[];
  authors?: Author[];
  readTime?: string;
}

// Props can still override JSON defaults
const {
  title = content.title,
  highlightWord = content.highlightWord,
  description = content.description,
  posts: rawPosts,
  categories = [],
  authors = [],
  readTime = content.readTime
} = Astro.props;

// Apply CMS configuration
const posts = applyCMSConfig(rawPosts, CMS_SECTIONS.KNOWLEDGE_SLIDER, 'blog');

// Build reference lookups for generateCMSAttributes
const categoriesMap = new Map(categories.map(c => [c.id, c]));
const authorsMap = new Map(authors.map(a => [a.id, a]));
const referenceLookups = {
  categories: categoriesMap,
  'team-members': authorsMap,
};

// Helper functions
function getCategory(categoryId: string | undefined): Category | undefined {
  if (!categoryId) return undefined;
  return categories.find(c => c.id === categoryId);
}

function getAuthor(authorId: string | undefined): Author | undefined {
  if (!authorId) return undefined;
  return authors.find(a => a.id === authorId);
}

// Split title to highlight the specified word
function formatTitle(text: string, highlight: string) {
  return text.split(new RegExp(`(${highlight})`, 'i'));
}

const titleParts = formatTitle(title, highlightWord);
---

<section class="overflow-hidden">
  <div class="py-12 sm:py-16 md:py-24 lg:py-32">
    <div class="px-4 md:px-8 lg:px-12">
      <div class="max-w-7xl mx-auto">
        <div class="grid gap-14 max-w-full overflow-x-hidden knowledge-slider">
          <!-- Header with nav -->
          <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-6 relative">
            <div class="flex-1 min-w-0">
              <h2 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl font-medium text-surface-900 break-words">
                {titleParts.map((part) =>
                  part.toLowerCase() === highlightWord.toLowerCase()
                    ? <span class="text-surface-400">{part}</span>
                    : part
                )}
              </h2>
              <div class="h-4"></div>
              <div class="max-w-full md:max-w-xl">
                <p class="text-surface-600 text-base md:text-lg">{description}</p>
              </div>
            </div>
            <div class="hidden md:flex md:shrink-0">
              <div class="flex gap-2">
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__prev"
                  aria-label="Previous slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__next"
                  aria-label="Next slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Embla Carousel -->
          <div
            id="knowledge-slider"
            class="embla w-full max-w-full overflow-hidden"
            data-cms-section={CMS_SECTIONS.KNOWLEDGE_SLIDER}
            data-cms-label="Blog Posts"
          >
            {posts.length > 0 ? (
              <div class="embla__viewport overflow-hidden">
                <div class="embla__container flex items-start gap-6 xs:gap-6 touch-pan-y" data-cms-container>
                  {posts.map((post) => {
                    const category = getCategory(post.category);
                    const author = getAuthor(post.author);
                    return (
                      <div
                        class="embla__slide flex-[0_0_100%] xs:flex-[0_0_auto] min-w-0 max-w-full xs:max-w-[26.25rem]"
                        {...generateCMSAttributes(post, 'blog', referenceLookups)}
                      >
                        <a href={`/blog/${post.slug}`} class="flex flex-col gap-4 max-w-full xs:max-w-[26.25rem] no-underline transition-opacity duration-250 hover:opacity-75 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-4 rounded-lg">
                          <div class="aspect-video w-full max-h-[50vh] overflow-hidden rounded-lg">
                            <img
                              src={post.thumbnail?.url || 'https://d3e54v103j8qbb.cloudfront.net/plugins/Basic/assets/placeholder.60f9b1840c.svg'}
                              loading="lazy"
                              width="420"
                              height="240"
                              alt={post.thumbnail?.alt || post.name}
                              class="w-full h-full object-cover transition-transform duration-300 hover:scale-[1.02]"
                            />
                          </div>
                          <div class="flex flex-col">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                              <div class="flex gap-4 items-center">
                                <span class="inline-block border border-surface-200 rounded-full py-1 px-3">
                                  <span class="font-medium text-sm">
                                    {category?.name || 'Uncategorized'}
                                  </span>
                                </span>
                                <span class="opacity-50">
                                  <span class="font-medium text-base">{readTime}</span>
                                </span>
                              </div>
                              <div class="text-xs font-medium text-surface-600">
                                <span>Author:</span>
                                <span class="font-bold ml-1">{author?.name || 'LoudFace'}</span>
                              </div>
                            </div>
                            <div class="h-3"></div>
                            <h3 class="text-lg font-medium text-surface-900 line-clamp-2">{post.name}</h3>
                            <div class="h-2"></div>
                            <p class="text-surface-600 line-clamp-2">{post.excerpt}</p>
                            <div class="hidden sm:block">
                              <div class="h-3"></div>
                              <span class="inline-flex items-center gap-1 text-surface-900 font-medium hover:opacity-75 transition-opacity">
                                Read more
                                <svg width="14" height="14" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M2.91854 1.85641H8.14011L1.06819 8.92834C1.01486 8.98166 0.972567 9.04496 0.94371 9.11463C0.914853 9.1843 0.9 9.25897 0.9 9.33437C0.9 9.40978 0.914853 9.48445 0.94371 9.55412C0.972567 9.62379 1.01486 9.68709 1.06818 9.74041C1.12151 9.79373 1.18481 9.83603 1.25448 9.86488C1.32414 9.89374 1.39881 9.90859 1.47422 9.90859C1.54963 9.90859 1.6243 9.89374 1.69396 9.86488C1.76363 9.83603 1.82693 9.79373 1.88025 9.74041L8.95193 2.66873V7.91349C8.95193 8.06562 9.01236 8.21153 9.11994 8.3191C9.22752 8.42668 9.37342 8.48711 9.52555 8.48711C9.67769 8.48711 9.82359 8.42668 9.93116 8.3191C10.0387 8.21153 10.0992 8.06562 10.0992 7.91349V1.31361C10.0997 1.30337 10.1 1.29311 10.1 1.28281C10.1 1.13052 10.0395 0.984466 9.93182 0.876779C9.82413 0.769092 9.67807 0.708594 9.52578 0.708594C9.51717 0.708594 9.50858 0.708787 9.50001 0.709172H2.91854C2.7664 0.709172 2.6205 0.769607 2.51292 0.877182C2.40535 0.984757 2.34491 1.13066 2.34491 1.28279C2.34491 1.43493 2.40535 1.58083 2.51292 1.6884C2.6205 1.79598 2.7664 1.85641 2.91854 1.85641Z" fill="currentColor" stroke="white" stroke-width="0.2"></path>
                                </svg>
                              </span>
                            </div>
                          </div>
                        </a>
                      </div>
                    );
                  })}
                </div>
              </div>
            ) : (
              <div class="text-center py-12 text-surface-500">
                <p>No blog posts found.</p>
              </div>
            )}
          </div>

          <!-- Mobile nav buttons -->
          <div class="block md:hidden">
            <div class="flex justify-center">
              <div class="flex gap-2">
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__prev"
                  aria-label="Previous slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button
                  class="flex items-center justify-center w-12 h-12 bg-surface-100 rounded-full text-surface-700 transition-all duration-200 hover:bg-surface-200 hover:scale-105 focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 active:scale-95 embla__next"
                  aria-label="Next slide"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Embla Carousel essentials */
  .knowledge-slider .embla__slide {
    flex: 0 0 100%;
    min-width: 0;
    max-width: 26.25rem;
  }

  @media (max-width: 474px) {
    .knowledge-slider .embla__slide {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>
