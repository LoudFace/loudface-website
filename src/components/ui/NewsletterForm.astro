---
import { getNewsletterContent } from '../../lib/content-utils';

// Load content from JSON file (editable via /dev/editor)
const content = getNewsletterContent();

interface Props {
  class?: string;
  variant?: 'light' | 'dark';
  placeholder?: string;
  buttonText?: string;
  loadingText?: string;
  successMessage?: string;
  errorMessage?: string;
  networkErrorMessage?: string;
}

// Props can still override JSON defaults
const {
  class: className = '',
  variant = 'dark',
  placeholder = content.placeholder,
  buttonText = content.buttonText,
  loadingText = content.loadingText,
  successMessage = content.successMessage,
  errorMessage = content.errorMessage,
  networkErrorMessage = content.networkErrorMessage
} = Astro.props;

const inputClasses = variant === 'dark'
  ? 'bg-transparent text-surface-400 placeholder:text-surface-500 border-surface-700 focus:border-primary-500'
  : 'bg-white text-surface-900 placeholder:text-surface-400 border-surface-200 focus:border-primary-500';

const buttonClasses = variant === 'dark'
  ? 'bg-surface-50 text-surface-900 hover:bg-surface-200'
  : 'bg-surface-900 text-white hover:bg-surface-800';

const successClasses = variant === 'dark'
  ? 'bg-green-800 text-white'
  : 'bg-green-100 text-green-800';

const errorClasses = variant === 'dark'
  ? 'bg-red-800/80 text-surface-100'
  : 'bg-red-100 text-red-800';
---

<div class:list={["w-full", className]} data-newsletter-form>
  <form class="flex flex-col sm:flex-row gap-3" data-newsletter-form-element>
    <label for="newsletter-email" class="sr-only">Email address</label>
    <input
      class:list={[
        "flex-1 px-4 py-3 rounded-lg border text-base font-medium",
        "transition-colors duration-200",
        "focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2",
        inputClasses
      ]}
      maxlength="256"
      name="email"
      placeholder={placeholder}
      type="email"
      id="newsletter-email"
      required
      autocomplete="email"
    />
    <button
      type="submit"
      class:list={[
        "px-6 py-3 rounded-lg text-base font-medium",
        "transition-colors duration-200",
        "focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2",
        "disabled:opacity-50 disabled:cursor-not-allowed",
        buttonClasses
      ]}
      data-newsletter-submit
    >
      <span data-newsletter-submit-text>{buttonText}</span>
      <span data-newsletter-submit-loading class="hidden">{loadingText}</span>
    </button>
  </form>
  <div
    class:list={["mt-3 p-3 rounded text-sm hidden", successClasses]}
    data-newsletter-success
  >
    <div>{successMessage}</div>
  </div>
  <div
    class:list={["mt-3 p-3 rounded text-xs hidden", errorClasses]}
    data-newsletter-error
  >
    <div data-newsletter-error-message data-default-error={errorMessage} data-network-error={networkErrorMessage}>{errorMessage}</div>
  </div>
</div>

<script>
  function initNewsletterForms() {
    const forms = document.querySelectorAll('[data-newsletter-form]');

    forms.forEach((container) => {
      const form = container.querySelector('[data-newsletter-form-element]') as HTMLFormElement;
      const submitBtn = container.querySelector('[data-newsletter-submit]') as HTMLButtonElement;
      const submitText = container.querySelector('[data-newsletter-submit-text]') as HTMLElement;
      const submitLoading = container.querySelector('[data-newsletter-submit-loading]') as HTMLElement;
      const successEl = container.querySelector('[data-newsletter-success]') as HTMLElement;
      const errorEl = container.querySelector('[data-newsletter-error]') as HTMLElement;
      const errorMessage = container.querySelector('[data-newsletter-error-message]') as HTMLElement;

      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const email = formData.get('email') as string;

        // Show loading state
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        errorEl.classList.add('hidden');

        try {
          const response = await fetch('/api/newsletter', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Show success
            form.classList.add('hidden');
            successEl.classList.remove('hidden');
          } else {
            // Show error - use data attribute for default message
            const defaultError = errorMessage.dataset.defaultError || 'Oops! Something went wrong while submitting the form.';
            errorMessage.textContent = result.message || defaultError;
            errorEl.classList.remove('hidden');
          }
        } catch (error) {
          // Show error - use data attribute for network error message
          const networkError = errorMessage.dataset.networkError || 'Network error. Please try again.';
          errorMessage.textContent = networkError;
          errorEl.classList.remove('hidden');
        } finally {
          // Reset loading state
          submitBtn.disabled = false;
          submitText.classList.remove('hidden');
          submitLoading.classList.add('hidden');
        }
      });
    });
  }

  // Initialize on load
  initNewsletterForms();

  // Re-initialize on page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initNewsletterForms);
</script>
