---
import { getFAQContent } from '../../lib/content-utils';
import SectionContainer from './SectionContainer.astro';
import SectionHeader from './SectionHeader.astro';
import Button from './Button.astro';

// Load content from JSON file (editable via /dev/editor)
const content = getFAQContent();

interface FAQItem {
  question: string;
  answer: string;
}

interface Props {
  title?: string;
  subtitle?: string;
  items: FAQItem[];
  showFooter?: boolean;
  footerTitle?: string;
  footerText?: string;
  footerCtaText?: string;
}

// Props can still override JSON defaults
const {
  title = content.title,
  subtitle = content.subtitle,
  items,
  showFooter = true,
  footerTitle = content.footerTitle,
  footerText = content.footerText,
  footerCtaText = content.footerCtaText
} = Astro.props;

// Extract the last word for highlighting
const titleWords = title.split(' ');
const highlightWord = titleWords.length > 1 ? titleWords[titleWords.length - 1] : undefined;

// Strip HTML tags from answer for schema (answers may contain <br> tags)
function stripHtml(html: string): string {
  return html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
}

// Generate FAQPage structured data
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": items.map(item => ({
    "@type": "Question",
    "name": item.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": stripHtml(item.answer)
    }
  }))
};
---

<!-- FAQPage Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

<SectionContainer>
  <!-- Header - always on top -->
  <div class="mb-8 lg:mb-12">
    <SectionHeader
      title={title}
      highlightWord={highlightWord}
      subtitle={subtitle}
    />
  </div>

  <!-- FAQ Items + Footer CTA -->
  <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8 lg:gap-12">
    <!-- FAQ Items -->
    <div class="space-y-0 divide-y divide-surface-200 border-y border-surface-200">
      {items.map((item) => (
        <details class="group faq-details">
          <summary class="flex items-center justify-between gap-4 py-5 cursor-pointer list-none select-none hover:bg-surface-50 -mx-4 px-4 transition-colors focus-visible:outline-2 focus-visible:outline-primary-500 focus-visible:outline-offset-2 rounded-lg">
            <span class="text-base md:text-lg font-medium text-surface-900 pr-4">
              {item.question}
            </span>
            <span class="flex-shrink-0 w-6 h-6 relative" aria-hidden="true">
              <span class="absolute top-1/2 left-0 w-6 h-0.5 bg-surface-400 -translate-y-1/2 transition-transform group-open:rotate-0"></span>
              <span class="absolute top-1/2 left-0 w-6 h-0.5 bg-surface-400 -translate-y-1/2 rotate-90 transition-transform group-open:rotate-0"></span>
            </span>
          </summary>
          <div class="pb-5 pr-10 text-surface-600 leading-relaxed overflow-hidden animate-fade-in">
            <p set:html={item.answer} />
          </div>
        </details>
      ))}
    </div>

    <!-- Footer CTA -->
    {showFooter && (
      <div class="lg:pl-8 lg:text-left text-center flex flex-col justify-start">
        <h3 class="text-xl font-bold text-surface-900">{footerTitle}</h3>
        <p class="mt-2 text-surface-600">{footerText}</p>
        <div class="mt-4">
          <Button
            variant="secondary"
            size="lg"
            calLink="arnelbukva/loudface-intro-call"
          >
            {footerCtaText}
          </Button>
        </div>
      </div>
    )}
  </div>
</SectionContainer>

<style>
  /* Remove default details marker */
  .faq-details summary::-webkit-details-marker {
    display: none;
  }
  .faq-details summary::marker {
    display: none;
  }
</style>
